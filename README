This is a simple Rails plugin do do action caching with memcache and have nginx pull the cached pages from memcache directly. So requests for cached pages don't even hit your Rails app server.

The problem with this kind of caching is that NginX and Rails somwhow have to communicate about what to cache and where to find the cached pages (the cache_key).

To accomplish the first I decided to use use a cookie - set by Rails - to tell NginX what NOT to cache. In out case we do a timed expiration of pages for not logged in users, but you can define your own rules. So if s/o logs in, he gets the prevent_action_caching cookie set and NginX never passes his requests memcache.

And NginX sets a custom header - Mem-Cache-Key - to tell Rails about the cache key. This way the contruction of the cache key is done just at one place: NginX. Mostly, at least as Rails adds 'views/' in front of every given action cache key.

To make this plugin work you have to have rules similar to these in your NginX configuration:



set $memcached_key_postfix  '$host$request_uri'; # construct the cache key.
set $memcached_key          views/$memcached_key_postfix;      # rails automagically prepends a 'views/' string, so we do the same.

# We set the proxy headers to the values of the original request
# and add a custom header for the cache-key.
proxy_set_header  Mem-Cache-Key   $memcached_key_postfix;

upstream backend {
  server 10.0.2.6:80;
}

location / {
  
  # ... typically the rules for your static files are here
  
  # We should not cache POSTs, do we? ;)  So POSTs got straight to the backend:
  if ($request_method = POST) {
    proxy_pass http://backend;
    add_header X-NXR "http post";
    break;
  }
  
  # We don't cache those, either (what would the prevent_action_caching cookie be good for otherwise).
  if ($http_cookie ~ "prevent_action_caching=true"){
    proxy_pass http://backend;
    add_header X-NXR "prevent action caching true";
    break;
  }
  
  #################
  # Mem-Cache part:
  
  # We set the default mime-type and charset explicitly so it's used for cached pages.
  default_type  text/html;
  charset       utf-8;
  
  
  # We're using /internal_backend_reference to prevent an endless loop.
  # 404 means a missed cache, 502 a missing mem-cache server.
  if ($http_cookie !~ "prevent_action_caching=true"){
    add_header X-NXR "can we pull out of cache?";
    memcached_pass   10.0.2.40:11211;
    add_header X-NXR "yes, we can!";
    
    error_page 404 502 = /internal_backend_reference;
    
    break;
  }
  
  proxy_pass http://backend;
}
